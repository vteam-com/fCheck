<svg width="1200" height="1200" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <style>
      .actor-box {
        fill: #2563eb;
        stroke: #1e40af;
        stroke-width: 2;
      }

      .actor-text {
        fill: white;
        font-family: 'Segoe UI', Arial, sans-serif;
        font-size: 14px;
        font-weight: bold;
      }

      .lifeline {
        stroke: #6b7280;
        stroke-width: 2;
        stroke-dasharray: 5, 5;
      }

      .activation {
        fill: #fef3c7;
        stroke: #f59e0b;
        stroke-width: 2;
      }

      .message-arrow {
        stroke: #10b981;
        stroke-width: 2;
        fill: none;
        marker-end: url(#arrowhead);
      }

      .return-arrow {
        stroke: #ef4444;
        stroke-width: 2;
        fill: none;
        stroke-dasharray: 3, 3;
        marker-end: url(#arrowhead-red);
      }

      .message-text {
        fill: #374151;
        font-family: 'Segoe UI', Arial, sans-serif;
        font-size: 12px;
      }

      .note-box {
        fill: #f0f9ff;
        stroke: #0284c7;
        stroke-width: 1;
      }

      .note-text {
        fill: #0c4a6e;
        font-family: 'Segoe UI', Arial, sans-serif;
        font-size: 11px;
      }

      .title {
        fill: #111827;
        font-family: 'Segoe UI', Arial, sans-serif;
        font-size: 18px;
        font-weight: bold;
      }

      .subtitle {
        fill: #6b7280;
        font-family: 'Segoe UI', Arial, sans-serif;
        font-size: 14px;
      }

      .section-label {
        fill: #7c3aed;
        font-family: 'Segoe UI', Arial, sans-serif;
        font-size: 13px;
        font-weight: bold;
      }
    </style>
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#10b981" />
    </marker>
    <marker id="arrowhead-red" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#ef4444" />
    </marker>
  </defs>

  <!-- White background -->
  <rect width="900" height="1100" fill="white" />

  <!-- Title -->
  <text x="450" y="30" text-anchor="middle" class="title">fcheck Unified Analysis Sequence Diagram</text>
  <text x="450" y="50" text-anchor="middle" class="subtitle">Single-Pass Traversal with Delegate Pattern</text>

  <!-- Actors -->
  <rect x="50" y="80" width="120" height="40" rx="5" class="actor-box" />
  <text x="110" y="105" text-anchor="middle" class="actor-text">User/CLI</text>

  <rect x="220" y="80" width="120" height="40" rx="5" class="actor-box" />
  <text x="280" y="105" text-anchor="middle" class="actor-text">AnalyzeFolder</text>

  <rect x="390" y="80" width="140" height="40" rx="5" class="actor-box" />
  <text x="460" y="105" text-anchor="middle" class="actor-text">AnalyzerRunner</text>

  <rect x="580" y="80" width="120" height="40" rx="5" class="actor-box" />
  <text x="640" y="105" text-anchor="middle" class="actor-text">File System</text>

  <rect x="750" y="80" width="120" height="40" rx="5" class="actor-box" />
  <text x="810" y="105" text-anchor="middle" class="actor-text">Delegates</text>

  <!-- Lifelines -->
  <line x1="110" y1="120" x2="110" y2="1050" class="lifeline" />
  <line x1="280" y1="120" x2="280" y2="1050" class="lifeline" />
  <line x1="460" y1="120" x2="460" y2="1050" class="lifeline" />
  <line x1="640" y1="120" x2="640" y2="1050" class="lifeline" />
  <line x1="810" y1="120" x2="810" y2="1050" class="lifeline" />

  <!-- Section 1: Initialization -->
  <text x="50" y="160" class="section-label">1. Initialization</text>

  <rect x="270" y="170" width="20" height="40" class="activation" />
  <line x1="110" y1="180" x2="270" y2="180" class="message-arrow" />
  <text x="190" y="175" text-anchor="middle" class="message-text">analyze()</text>

  <rect x="450" y="190" width="20" height="60" class="activation" />
  <line x1="290" y1="200" x2="450" y2="200" class="message-arrow" />
  <text x="370" y="195" text-anchor="middle" class="message-text">create delegates</text>

  <!-- Note about delegates -->
  <rect x="490" y="190" width="180" height="50" rx="3" class="note-box" />
  <text x="500" y="205" class="note-text">Creates 5 delegates:</text>
  <text x="500" y="220" class="note-text">• HardcodedStringDelegate</text>
  <text x="500" y="235" class="note-text">• MagicNumberDelegate</text>

  <!-- Section 2: File Discovery -->
  <text x="50" y="280" class="section-label">2. Single File Discovery</text>

  <rect x="630" y="290" width="20" height="40" class="activation" />
  <line x1="470" y1="300" x2="630" y2="300" class="message-arrow" />
  <text x="550" y="295" text-anchor="middle" class="message-text">listDartFiles()</text>

  <line x1="630" y1="320" x2="470" y2="320" class="return-arrow" />
  <text x="550" y="335" text-anchor="middle" class="message-text">List&lt;File&gt;</text>

  <!-- Section 3: Unified Analysis Loop -->
  <text x="50" y="380" class="section-label">3. Unified Analysis Loop</text>

  <rect x="450" y="390" width="20" height="400" class="activation" />

  <!-- Loop box -->
  <rect x="480" y="390" width="340" height="380" fill="none" stroke="#9333ea" stroke-width="2" stroke-dasharray="5,5"
    rx="5" />
  <text x="490" y="410" class="section-label">for each file</text>

  <!-- File parsing -->
  <rect x="630" y="420" width="20" height="30" class="activation" />
  <line x1="470" y1="430" x2="630" y2="430" class="message-arrow" />
  <text x="550" y="425" text-anchor="middle" class="message-text">readAsStringSync()</text>

  <line x1="630" y1="445" x2="470" y2="445" class="return-arrow" />
  <text x="550" y="460" text-anchor="middle" class="message-text">file content</text>

  <!-- AST parsing -->
  <rect x="450" y="470" width="20" height="40" class="activation" />
  <text x="480" y="485" class="note-text">parseString() - AST</text>
  <text x="480" y="500" class="note-text">AnalysisFileContext</text>

  <!-- Delegate processing -->
  <rect x="800" y="520" width="20" height="200" class="activation" />

  <line x1="470" y1="530" x2="800" y2="530" class="message-arrow" />
  <text x="635" y="525" text-anchor="middle" class="message-text">analyzeFileWithContext(context)</text>

  <!-- Individual delegate calls -->
  <text x="830" y="550" class="note-text">HardcodedStringDelegate</text>
  <text x="830" y="570" class="note-text">MagicNumberDelegate</text>
  <text x="830" y="590" class="note-text">SourceSortDelegate</text>
  <text x="830" y="610" class="note-text">LayersDelegate</text>
  <text x="830" y="630" class="note-text">SecretDelegate</text>

  <line x1="800" y1="680" x2="470" y2="680" class="return-arrow" />
  <text x="635" y="695" text-anchor="middle" class="message-text">List&lt;Issues&gt;</text>

  <!-- Section 4: Results Aggregation -->
  <text x="50" y="820" class="section-label">4. Results Aggregation</text>

  <rect x="450" y="830" width="20" height="60" class="activation" />
  <text x="480" y="845" class="note-text">AnalyzerRunnerResult</text>
  <text x="480" y="860" class="note-text">• resultsByType</text>
  <text x="480" y="875" class="note-text">• analyzerStats</text>

  <!-- Section 5: File Metrics -->
  <text x="50" y="920" class="section-label">5. File Metrics (LOC/Comments)</text>

  <rect x="630" y="930" width="20" height="40" class="activation" />
  <line x1="290" y1="940" x2="630" y2="940" class="message-arrow" />
  <text x="460" y="935" text-anchor="middle" class="message-text">analyzeFile() for each file</text>

  <line x1="630" y1="960" x2="290" y2="960" class="return-arrow" />
  <text x="460" y="975" text-anchor="middle" class="message-text">FileMetrics</text>

  <!-- Section 6: Layers Analysis (Special Case) -->
  <text x="50" y="1010" class="section-label">6. Layers Analysis (Dependency Graph)</text>

  <rect x="630" y="1020" width="20" height="40" class="activation" />
  <line x1="290" y1="1030" x2="630" y2="1030" class="message-arrow" />
  <text x="460" y="1025" text-anchor="middle" class="message-text">LayersAnalyzer.analyzeDirectory()</text>

  <line x1="630" y1="1050" x2="290" y2="1050" class="return-arrow" />
  <text x="460" y="1065" text-anchor="middle" class="message-text">LayersAnalysisResult</text>

  <!-- Final return -->
  <line x1="280" y1="1090" x2="110" y2="1090" class="return-arrow" />
  <text x="190" y="1105" text-anchor="middle" class="message-text">ProjectMetrics</text>
</svg>